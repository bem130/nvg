<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Neknaj Video Generator</title>
        <link rel="stylesheet" href="index.css" />
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
        <script src="logarea.js"></script>
        <script src="index.js"></script>
        <script src="../node_modules/ace-builds/src/ace.js"></script>
        <script src="../node_modules/ace-builds/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
        <script src="../node_modules/neknaj-jsonviewer/jsonviewer.js"></script>
        <link rel="stylesheet" href="../node_modules/neknaj-jsonviewer/jsonviewer.css" />
        <link rel="stylesheet" href="logarea.css" />
    </head>
    <body>
        <div id="topbar">
            <div>
                <img src="./nvg.png">
            </div>
            <div>
                <button type="button" id="export">Export</button>
                <button type="button" id="openfile">Open File</button>
                <button type="button" id="savefileas">Save As</button>
                <div>
                    <input type="checkbox" switch id="autosave"><label>Auto Save</label>
                </div>
            </div>
            <div>
                <span id="title">　</span>
            </div>
        </div>
        <div id="mainarea" class="resizer_Vcontainer" style="height: calc(100% - 26px);">
            <div class="resizer_content" style="flex-basis: 100%;">
                <div class="resizer_Vcontainer" style="height: 100%;">
                    <div class="resizer_content" style="flex-basis: 80%;">
                        <div class="resizer_Hcontainer" style="height: 100%;">
                            <div class="resizer_content" style="flex-basis: 70%;" id="imgOutArea">
                                <div class="imgOutWindow">
                                    <div id="timebar_padding"></div>
                                    <canvas id="imgOut" style="transform: scale(0,0);"></canvas>
                                    <div id="timebar">
                                        <input id="playbutton" type="radio"><label for="playbutton" id="playbuttonlabel">&#x23ef;</label>
                                        <span id="currentFrame">0</span>
                                        <input type="range" id="seekbar" value="0" min="0" max="1000">
                                    </div>
                                </div>
                            </div>
                            <div class="resizer_splitter"></div>
                            <div class="resizer_content" style="flex-basis: 30%;">
                                <div id="editor" style="height: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content" style="flex-basis: 20%;">
                        <div id="timelinearea">
                            <div id="timeline" style="width: calc( 1000px *var(--tl-x-scale))">
                                <div id="tl_timebar" style="left:calc( 10px *var(--tl-x-scale));"></div>
                                <div id="tl_objects">
                                    <div class="object" style="left:calc( 0px *var(--tl-x-scale));top:calc(0 *(30px*var(--tl-y-scale) + 5px));width: calc( 80px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 530px *var(--tl-x-scale));top:calc(0 *(30px*var(--tl-y-scale) + 5px));width: calc( 180px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 120px *var(--tl-x-scale));top:calc(0 *(30px*var(--tl-y-scale) + 5px));width: calc( 200px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 50px *var(--tl-x-scale));top:calc(1 *(30px*var(--tl-y-scale) + 5px));width: calc( 10px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 320px *var(--tl-x-scale));top:calc(1 *(30px*var(--tl-y-scale) + 5px));width: calc( 180px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 50px *var(--tl-x-scale));top:calc(2 *(30px*var(--tl-y-scale) + 5px));width: calc( 80px *var(--tl-x-scale))"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resizer_splitter"></div>
            <div class="resizer_content" style="flex-basis: 0%;"><div id="logarea"></div></div>
        </div>
        <div id="subarea" data-open="close" data-loc="left">subarea</div>
    </body>
</html>
<script>
function resizer_Vcontainer_addEL (container,framesMin,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let y = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.y-containerRect.y,framesMin,containerRect.height-resizerW-framesMin);
            container.querySelectorAll(":scope > .resizer_content")[0].style.flexBasis = `${y}%`;
            container.querySelectorAll(":scope > .resizer_content")[1].style.flexBasis = `${containerRect.height-resizerW-y}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
function resizer_Hcontainer_addEL (container,framesMin,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let x = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.x-containerRect.x,framesMin,containerRect.width-resizerW-framesMin);
            container.querySelectorAll(":scope > .resizer_content")[0].style.flexBasis = `${x}%`;
            container.querySelectorAll(":scope > .resizer_content")[1].style.flexBasis = `${containerRect.width-resizerW-x}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
</script>
<script>

var editor;
var ProjecInfo = {
    path: null,
    name: null,
}

function SetWindowTitle() {
    document.title = [
        "Neknaj Video Generator",
        data2string(ProjecInfo.name),
        data2string(ProjecInfo.path),
    ].join(" ")
    document.getElementById("title").innerText = [
        data2string(ProjecInfo.name),
        data2string(ProjecInfo.path),
    ].join("　");
}

function data2string(data) {
    if (typeof data=="string") {
        return "\""+data+"\"";
    }
    else {
        return data;
    }
}


function sleep(time) {new Promise(resolve=>setTimeout(resolve,time))}

document.getElementById("openfile").onclick = ()=>{
    window.electron.openFile();
}
document.getElementById("savefileas").onclick = ()=>{
    window.electron.saveAs(editor.getValue());
}
let autosave = document.getElementById("autosave");



let videoConfig = {
    "height": 1080,
    "width": 1920,
}

var imgout = document.getElementById("imgOut");

let imgOutArea = document.getElementById("imgOutArea");
// resize window
function resize() {
    {
        const dw = videoConfig.width;
        const dh = videoConfig.height;
        let rw = 0;let rh = 0;
        parent = imgOutArea.getBoundingClientRect();
        let bottom_area = 30;
        let ww = parent.width;
        let wh = parent.height-bottom_area;
        let csc = 1
        hcsc = ww/dw; wcsc = wh/dh;
        if (hcsc>wcsc) {
            csc = wcsc; rw = (ww - dw*csc)/2;
        }
        else {
            csc = hcsc; rh = (wh - dh*csc)/2;
        }
        document.getElementById("imgOut").style.marginTop = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginBottom = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginLeft = (rw).toString()+"px";
        document.getElementById("imgOut").style.marginRight = (rw).toString()+"px";
        document.getElementById("imgOut").style.transform = "scale("+csc.toString()+","+csc.toString()+")";
    }
    {
        Timeline.style.setProperty('--tl-timebar-height',
            Math.max(TimelineArea.getBoundingClientRect().height-13)+"px"
        );
    }
};
window.onresize = resize;
window.onload = ()=>{
    imgout.height = videoConfig.height;
    imgout.width = videoConfig.width;
    resize();
    SetWindowTitle();
    initEditor();
    Previewzero();
};
function initEditor() {
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/cobalt");
   // editor.getSession().setMode("ace/mode/javascript");
    editor.getSession().setMode(new (ace.require("ace/mode/javascript").Mode)())
    editor.container.addEventListener("keydown",(e)=>{
        if (e.ctrlKey&&e.key=="o") {
            let cursor = editor.selection.getCursor()
            if (ProjecInfo.path!=null) {
                location.href = ["vscode://file/",ProjecInfo.path,":"+cursor.row+":"+cursor.column].join("");
            }
        }
    })
    editor.getSession().on('change', function(){
        if (autosave.checked&&ProjecInfo.path!=null) {
            window.electron.saveFile(ProjecInfo.path,editor.getValue());
        }
    });
}
</script>
<script> /* Timeline */
let TimelineArea = document.getElementById("timelinearea");
let Timeline = document.getElementById("timeline");
let TimelineObjects = document.getElementById("tl_objects");
let TimelineScale = [0,0];
TimelineArea.addEventListener("wheel",(e)=>{
    if (e.ctrlKey&&!e.shiftKey) { // x軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[0]++;}else {TimelineScale[0]--;}
        if (TimelineScale[0]>20) {TimelineScale[0]=20}
        else if (TimelineScale[0]<-20) {TimelineScale[0]=-20}
        console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.8**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.9**TimelineScale[1]);
    }
    else if (e.ctrlKey&&e.shiftKey) { // y軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[1]++;}else {TimelineScale[1]--;}
        if (TimelineScale[1]>10) {TimelineScale[1]=10}
        else if (TimelineScale[1]<-10) {TimelineScale[1]=-10}
        console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.8**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.9**TimelineScale[1]);
    }
    else {
    }
})

</script>
<script>
document.querySelectorAll(".resizer_Vcontainer").forEach((x)=>{resizer_Vcontainer_addEL(x,0,10,resize);})
document.querySelectorAll(".resizer_Hcontainer").forEach((x)=>{resizer_Hcontainer_addEL(x,0,10,resize);})
</script>
<script> /* keyboard */
document.onkeydown = (e)=>{
    let subarea = document.getElementById("subarea");
    console.log(e.ctrlKey,e.shiftKey,e.keyCode)
    if (e.ctrlKey&&(!e.shiftKey)&&e.keyCode==66) {
        if (subarea.dataset.open=="open") {
            subarea.dataset.open = "close";
        }
        else {
            subarea.dataset.open = "open";
        }
    }
    if (e.ctrlKey&&e.shiftKey&&e.keyCode==66&&subarea.dataset.open=="open") {
        if (subarea.dataset.loc=="right") {
            subarea.dataset.loc = "left";
        }
        else {
            subarea.dataset.loc = "right";
        }
    }
    if (e.keyCode==32&&!editor.isFocused()) {
        playPreview();
    }
}
</script>
<script>

var currentFrame = 0;
let seekbar = document.querySelector("#seekbar");
let currentFrameShow = document.querySelector("#currentFrame");
let TimeLineTimeBar = document.querySelector("#tl_timebar");
let playbutton = document.querySelector("#playbutton");
seekbar.addEventListener("input",()=>{
    currentFrame = seekbar.value;
    TimeLineTimeBar.style = `left:calc( ${currentFrame}px *var(--tl-x-scale));`;
    currentFrameShow.innerText = currentFrame;
})
TimeLineTimeBar.addEventListener("mousedown",(e)=>{
    let resize = (e)=>{
        let ex = e.x - TimelineArea.getBoundingClientRect().left+ TimelineArea.scrollLeft;
        let x = ex/(0.8**TimelineScale[0]);
        if (x<0) {x=0};
        currentFrame = Math.floor(x);
        TimeLineTimeBar.style = `left:calc( ${currentFrame}px *var(--tl-x-scale));`;
        seekbar.value = currentFrame;
        currentFrameShow.innerText = currentFrame;
    }
    document.addEventListener("mousemove",resize,false);
    document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
});

function play() {
    currentFrame++;
    TimeLineTimeBar.style = `left:calc( ${currentFrame}px *var(--tl-x-scale));`;
    seekbar.value = currentFrame;
    currentFrameShow.innerText = currentFrame;
}
function Previewzero() {
    currentFrame = 0;
    TimeLineTimeBar.style = `left:calc( ${currentFrame}px *var(--tl-x-scale));`;
    seekbar.value = currentFrame;
    currentFrameShow.innerText = currentFrame;
}

var playInterval = null;
playbutton.addEventListener("click",()=>{
    TimelineArea.focus();
    playPreview();
})
function playPreview() {
    if (playInterval==null) {
        playInterval = setInterval(play,33);
    }
    else {
        clearInterval(playInterval);
        playInterval = null;
    }
}


</script>