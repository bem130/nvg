<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Neknaj Video Generator</title>
        <link rel="stylesheet" href="index.css" />
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
        <script src="../node_modules/ace-builds/src/ace.js"></script>
    </head>
    <body>
        <div id="topbar">
            <button type="button" id="export">Export</button>
            <button type="button" id="openfile">Open File</button>
            <button type="button" id="savefileas">Save As</button>
            <input type="checkbox" switch id="autosave"><label>Auto Save</label>
        </div>
        <div class="resizer_Vcontainer" style="height: calc(100% - 26px);" data-min1="200" data-min2="0">
            <div class="resizer_top" style="flex-basis: 100%;">
                <div class="resizer_Vcontainer" style="height: 100%;" data-min1="200" data-min2="100">
                    <div class="resizer_top" style="flex-basis: 70%;">
                        <div class="resizer_Hcontainer" style="height: 100%;" data-min1="100" data-min2="0">
                            <div class="resizer_left" style="flex-basis: 70%;" id="imgOutArea">
                                <div id="timebar_padding"></div>
                                <canvas id="imgOut"></canvas>
                                <input type="range" id="timebar">
                            </div>
                            <div class="resizer_splitter"></div>
                            <div class="resizer_right" style="flex-basis: 30%;">
                                <div id="editor" style="height: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_bottom" style="flex-basis: 30%;">
                        <div id="timelinearea">
                            <div id="timeline" style="width: calc( 1000px *var(--tl-x-scale))">
                                <div id="tl_timebar" style="left:calc( 10px *var(--tl-x-scale));"></div>
                                <div id="tl_objects">
                                    <div class="object" style="left:calc( 0px *var(--tl-x-scale));top:calc(0 *(30px*var(--tl-y-scale) + 5px));width: calc( 80px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 530px *var(--tl-x-scale));top:calc(0 *(30px*var(--tl-y-scale) + 5px));width: calc( 180px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 120px *var(--tl-x-scale));top:calc(0 *(30px*var(--tl-y-scale) + 5px));width: calc( 200px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 50px *var(--tl-x-scale));top:calc(1 *(30px*var(--tl-y-scale) + 5px));width: calc( 10px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 320px *var(--tl-x-scale));top:calc(1 *(30px*var(--tl-y-scale) + 5px));width: calc( 180px *var(--tl-x-scale))"></div>
                                    <div class="object" style="left:calc( 50px *var(--tl-x-scale));top:calc(2 *(30px*var(--tl-y-scale) + 5px));width: calc( 80px *var(--tl-x-scale))"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resizer_splitter"></div>
            <div class="resizer_bottom" style="flex-basis: 0%;">bottom</div>
        </div>
    </body>
</html>
<style>
.resizer_Vcontainer {
    display: flex;
    flex-direction: column;
    & .resizer_top, & .resizer_bottom {
        min-height: 0px;
        height: 100%;
        overflow: hidden;
        padding: 3px;
    }
    & .resizer_splitter {
        height: 5px;
        margin: 2px;
        width: calc(100% - 4px);
        border-radius: 3px;
        flex: none;
        cursor: row-resize;
        background-color: #adadad;
    }
}
.resizer_Hcontainer {
    display: flex;
    flex-direction: row;
    & .resizer_left, & .resizer_right {
        min-width: 0px;
        width: 100%;
        overflow: hidden;
        padding: 3px;
    }
    & .resizer_splitter {
        width: 5px;
        margin: 2px;
        height: calc(100% - 4px);
        border-radius: 3px;
        flex: none;
        cursor: col-resize;
        background-color: #adadad;
    }
}
</style>
<script>
function resizer_Vcontainer_addEL (container,frame1Min,frame2Min,resizerW,callback=()=>{}) {
    console.log(container)
    console.log(container.querySelector(":scope > .resizer_top"))
    console.log(container.querySelector(":scope > .resizer_bottom"))
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let y = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.y-containerRect.y,frame1Min,containerRect.height-resizerW-frame2Min);
            container.querySelector(":scope > .resizer_top").style.flexBasis = `${y}%`;
            container.querySelector(":scope > .resizer_bottom").style.flexBasis = `${containerRect.height-resizerW-y}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
function resizer_Hcontainer_addEL (container,frame1Min,frame2Min,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let x = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.x-containerRect.x,frame1Min,containerRect.width-resizerW-frame2Min);
            container.querySelector(":scope > .resizer_left").style.flexBasis = `${x}%`;
            container.querySelector(":scope > .resizer_right").style.flexBasis = `${containerRect.width-resizerW-x}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
</script>
<script>

var editor;
var ProjecInfo = {
    path: null,
    name: null,
}

function SetWindowTitle() {
    document.title = [
        "Neknaj Video Generator",
        data2string(ProjecInfo.name),
        data2string(ProjecInfo.path),
    ].join(" ")
}

function data2string(data) {
    if (typeof data=="string") {
        return "\""+data+"\"";
    }
    else {
        return data;
    }
}


function sleep(time) {new Promise(resolve=>setTimeout(resolve,time))}

document.getElementById("openfile").onclick = ()=>{
    window.electron.openFile();
}
document.getElementById("savefileas").onclick = ()=>{
    window.electron.saveAs(editor.getValue());
}
let autosave = document.getElementById("autosave");



let videoConfig = {
    "height": 1080,
    "width": 1920,
}

var imgout = document.getElementById("imgOut");

let imgOutArea = document.getElementById("imgOutArea");
// resize window
function resize() {
    {
        const dw = videoConfig.width;
        const dh = videoConfig.height;
        let rw = 0;let rh = 0;
        parent = imgOutArea.getBoundingClientRect();
        let bottom_area = 30;
        let ww = parent.width;
        let wh = parent.height-bottom_area;
        let csc = 1
        hcsc = ww/dw; wcsc = wh/dh;
        if (hcsc>wcsc) {
            csc = wcsc; rw = (ww - dw*csc)/2;
        }
        else {
            csc = hcsc; rh = (wh - dh*csc)/2;
        }
        document.getElementById("imgOut").style.marginTop = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginBottom = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginLeft = (rw).toString()+"px";
        document.getElementById("imgOut").style.marginRight = (rw).toString()+"px";
        document.getElementById("imgOut").style.transform = "scale("+csc.toString()+","+csc.toString()+")";
    }
    {
        Timeline.style.setProperty('--tl-timebar-height',
        Math.max(TimelineArea.getBoundingClientRect().height-5)+"px"
        );
    }
};
window.onresize = resize;
window.onload = ()=>{
    imgout.height = videoConfig.height;
    imgout.width = videoConfig.width;
    resize();
    SetWindowTitle();
    initEditor();
};
function initEditor() {
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/cobalt");
    editor.getSession().setMode("ace/mode/javascript");
    editor.container.addEventListener("keydown",(e)=>{
        if (e.ctrlKey&&e.key=="o") {
            let cursor = editor.selection.getCursor()
            if (ProjecInfo.path!=null) {
                location.href = ["vscode://file/",ProjecInfo.path,":"+cursor.row+":"+cursor.column].join("");
            }
        }
    })
    editor.getSession().on('change', function(){
        if (autosave.checked&&ProjecInfo.path!=null) {
            window.electron.saveFile(ProjecInfo.path,editor.getValue());
        }
    });
}
</script>
<script> /* Timeline */
let TimelineArea = document.getElementById("timelinearea");
let Timeline = document.getElementById("timeline");
let TimelineObjects = document.getElementById("tl_objects");
let TimelineScale = [0,0];
TimelineArea.addEventListener("wheel",(e)=>{
    if (e.ctrlKey&&!e.shiftKey) { // x軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[0]++;}else {TimelineScale[0]--;}
        if (TimelineScale[0]>20) {TimelineScale[0]=20}
        else if (TimelineScale[0]<-20) {TimelineScale[0]=-20}
        console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.8**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.9**TimelineScale[1]);
    }
    else if (e.ctrlKey&&e.shiftKey) { // y軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[1]++;}else {TimelineScale[1]--;}
        if (TimelineScale[1]>10) {TimelineScale[1]=10}
        else if (TimelineScale[1]<-10) {TimelineScale[1]=-10}
        console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.8**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.9**TimelineScale[1]);
    }
    else {
    }
})
let TimeLineTimeBar = document.getElementById("tl_timebar");
TimeLineTimeBar.addEventListener("mousedown",(e)=>{
    let resize = (e)=>{
        let x = e.x/(0.8**TimelineScale[0]);
        if (x<0) {x=0};
        TimeLineTimeBar.style = `left:calc( ${x}px *var(--tl-x-scale));`;
    }
    document.addEventListener("mousemove",resize,false);
    document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
});

</script>
<script src="index.js"></script>
<script>
document.querySelectorAll(".resizer_Vcontainer").forEach((x)=>{resizer_Vcontainer_addEL(x,Number(x.dataset.min1),Number(x.dataset.min2),10,resize);})
document.querySelectorAll(".resizer_Hcontainer").forEach((x)=>{resizer_Hcontainer_addEL(x,Number(x.dataset.min1),Number(x.dataset.min2),10,resize);})
</script>
<style>
    :root {
        color-scheme: dark;
    }
    body {
        width: 100vw;
        overflow: hidden;
    }
    #imgOut {
        position: absolute;
        left: 2px;
        top: calc(26px + 3px);
        transform-origin: top left;
        background-color: white;
        cursor: crosshair;
    }
    #underbar {
        border-top: 1px solid white;
        width: 100%;
        position: relative;
        bottom: 0;
        height: 26px;
        overflow-x: scroll;
        overflow-y: hidden;
    }
    #timebar_padding {
        height: 100%;
    }
    #timebar {
        position: relative;
        width: 100%;
        bottom: 20px;
        left: -5px;
    }

input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    outline: none;
    background: transparent;
    cursor: pointer;
}
/* Track: Chrome, Safari, Opera, Edge Chromium */
input[type="range"]::-webkit-slider-runnable-track {
    background: #383838;
    height: 20px;
    border-radius: 0;
}

/* Thumb: Chrome, Safari, Opera, Edge Chromium */
input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    height: 20px;
    width: 5px;
    margin-top: 0px;
    background-color: #4cabe2;
    border-radius: 0;
}

.ace_print-margin {
    visibility: hidden !important;
}
</style>
<style>/*timeline*/
#timelinearea {
    overflow: auto;
    height: 100%;
    z-index: -10;
    background-color: rgba(102, 115, 175, 0.204);
}
#timeline {
    --tl-y-scale: 1;
    --tl-x-scale2: 1;
    --tl-x-scale: var(--tl-x-scale2);
    max-height:100%;
    padding: 5px;
    transform: scale(1);
    z-index: -10;
    height: fit-content;
    & .object {
        background-color: rgb(152, 138, 206);
        height: calc(30px *var(--tl-y-scale));
        margin: 5px;
        padding: 0;
        position: absolute;
        &:hover {
            background-color: rgb(125, 99, 232);
        }
    }
    & #tl_timebar {
        background-color: rgb(255, 255, 255);
        width: 3px;
        height: var(--tl-timebar-height);
        position: absolute;
        z-index: 15;
        cursor: ew-resize;
    }
}
</style>