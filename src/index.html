<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Neknaj Video Generator</title>
        <link rel="stylesheet" href="index.css" />
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
        <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
        <script src="logarea.js"></script>
        <script src="index.js"></script>
        <script src="../node_modules/ace-builds/src/ace.js"></script>
        <script src="../node_modules/ace-builds/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
        <script src="../node_modules/neknaj-jsonviewer/jsonviewer.js"></script>
        <link rel="stylesheet" href="../node_modules/neknaj-jsonviewer/jsonviewer.css" />
        <link rel="stylesheet" href="logarea.css" />
    </head>
    <body>
        <div id="topbar">
            <div>
                <img src="./nvg.png">
            </div>
            <div>
                <button type="button" id="export">Export</button>
                <button type="button" id="openfile">Open File</button>
                <button type="button" id="savefileas">Save As</button>
                <button type="button" id="composevideo">Compose Video</button>
                <div>
                    <input type="checkbox" switch id="autosave"><label for="autosave">Auto Save</label>
                </div>
            </div>
            <div>
                <span id="title">　</span>
            </div>
        </div>
        <div id="mainarea" class="resizer_Vcontainer" style="height: calc(100% - 26px);">
            <div class="resizer_content" style="flex-basis: 100%;">
                <div class="resizer_Vcontainer" style="height: 100%;">
                    <div class="resizer_content" style="flex-basis: 80%;">
                        <div class="resizer_Hcontainer" style="height: 100%;">
                            <div class="resizer_content" style="flex-basis: 70%;" id="imgOutArea">
                                <div class="imgOutWindow">
                                    <div id="timebar_padding"></div>
                                    <canvas id="imgOut" style="transform: scale(0,0);"></canvas>
                                    <div id="timebar">
                                        <input id="playbutton" type="radio"><label for="playbutton" id="playbuttonlabel">&#x23ef;</label>
                                        <span id="currentFrame">0</span>
                                        <input type="range" id="seekbar" value="0" min="0" max="1000">
                                    </div>
                                </div>
                            </div>
                            <div class="resizer_splitter"></div>
                            <div class="resizer_content" style="flex-basis: 30%;">
                                <div id="editor" style="height: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content" style="flex-basis: 20%;">
                        <div id="timelinearea">
                            <div id="timeline" style="width: calc( 1000px *var(--tl-x-scale))">
                                <div id="tl_timebar" style="left:calc( 10px *var(--tl-x-scale));"></div>
                                <div id="tl_objects">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resizer_splitter"></div>
            <div class="resizer_content" style="flex-basis: 0%;"><div id="logarea"></div></div>
        </div>
        <div id="subarea" data-open="close" data-loc="left">
            <div class="resizer_Vcontainer" style="height: 100%;">
                <div class="resizer_content" style="flex-basis: 30%;">
                    <div id="partialexport">
                        <h3>Partial export</h3>
                        <table>
                            <tr>
                                <td>
                                    <label for="export_range_start">start:</label>
                                </td>
                                <td>
                                    <input type="number" id="export_range_start" min="0">
                                </td>
                                <td>
                                    <button>first frame</button>
                                </td>
                                <td>
                                    <button>current playback position</button>
                                </td>
                                <td>
                                    <button>last frame</button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <label for="export_range_end">end:</label>
                                </td>
                                <td>
                                    <input type="number" id="export_range_end" min="0">
                                </td>
                                <td>
                                    <button>first frame</button>
                                </td>
                                <td>
                                    <button>current playback position</button>
                                </td>
                                <td>
                                    <button>last frame</button>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="resizer_splitter"></div>
                <div class="resizer_content" style="flex-basis: 70%;">
                    2
                </div>
            </div>
        </div>
    </body>
</html>
<script>
function resizer_Vcontainer_addEL (container,framesMin,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let y = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.y-containerRect.y,framesMin,containerRect.height-resizerW-framesMin);
            container.querySelectorAll(":scope > .resizer_content")[0].style.flexBasis = `${y}%`;
            container.querySelectorAll(":scope > .resizer_content")[1].style.flexBasis = `${containerRect.height-resizerW-y}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
function resizer_Hcontainer_addEL (container,framesMin,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let x = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.x-containerRect.x,framesMin,containerRect.width-resizerW-framesMin);
            container.querySelectorAll(":scope > .resizer_content")[0].style.flexBasis = `${x}%`;
            container.querySelectorAll(":scope > .resizer_content")[1].style.flexBasis = `${containerRect.width-resizerW-x}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
</script>
<script>

var editor;
var ProjecInfo = {
    path: null,
    name: null,
}

function SetWindowTitle() {
    document.title = [
        "Neknaj Video Generator",
        data2string(ProjecInfo.name),
        data2string(ProjecInfo.path),
    ].join(" ")
    document.getElementById("title").innerText = [
        data2string(ProjecInfo.name),
        data2string(ProjecInfo.path),
    ].join("　");
}

function data2string(data) {
    if (typeof data=="string") {
        return "\""+data+"\"";
    }
    else {
        return data;
    }
}


function sleep(time) {new Promise(resolve=>setTimeout(resolve,time))}

document.getElementById("openfile").onclick = ()=>{
    if (exporting) {e.preventDefault();return false;}
    window.electron.openFile();
}
document.getElementById("savefileas").onclick = ()=>{
    if (exporting) {e.preventDefault();return false;}
    window.electron.saveAs(editor.getValue());
}
let autosave = document.getElementById("autosave");



let videoConfig = {
    "height": 1080,
    "width": 1920,
}
var exporting = false;

var imgout = document.getElementById("imgOut");

let imgOutArea = document.getElementById("imgOutArea");
// resize window
function resize() {
    {
        const dw = videoConfig.width;
        const dh = videoConfig.height;
        let rw = 0;let rh = 0;
        parent = imgOutArea.getBoundingClientRect();
        let bottom_area = 30;
        let ww = parent.width;
        let wh = parent.height-bottom_area;
        let csc = 1
        hcsc = ww/dw; wcsc = wh/dh;
        if (hcsc>wcsc) {
            csc = wcsc; rw = (ww - dw*csc)/2;
        }
        else {
            csc = hcsc; rh = (wh - dh*csc)/2;
        }
        document.getElementById("imgOut").style.marginTop = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginBottom = (rh).toString()+"px";
        document.getElementById("imgOut").style.marginLeft = (rw).toString()+"px";
        document.getElementById("imgOut").style.marginRight = (rw).toString()+"px";
        document.getElementById("imgOut").style.transform = "scale("+csc.toString()+","+csc.toString()+")";
    }
    {
        Timeline.style.setProperty('--tl-timebar-height',
            Math.max(TimelineArea.getBoundingClientRect().height-13)+"px"
        );
    }
};
window.onresize = resize;
window.onload = ()=>{
    imgout.height = videoConfig.height;
    imgout.width = videoConfig.width;
    resize();
    SetWindowTitle();
    initEditor();
    Previewzero();
};
function initEditor() {
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/cobalt");
   // editor.getSession().setMode("ace/mode/javascript");
    editor.getSession().setMode(new (ace.require("ace/mode/javascript").Mode)())
    editor.container.addEventListener("keydown",(e)=>{
        if (exporting) {e.preventDefault();return false;}
        if (e.ctrlKey&&e.key=="o") {
            let cursor = editor.selection.getCursor()
            if (ProjecInfo.path!=null) {
                location.href = ["vscode://file/",ProjecInfo.path,":"+cursor.row+":"+cursor.column].join("");
            }
        }
    })
    editor.getSession().on('change', function(){
        if (autosave.checked&&ProjecInfo.path!=null) {
            window.electron.saveFile(ProjecInfo.path,editor.getValue());
        }
    });
}
</script>
<script> /* Timeline */
let TimelineArea = document.getElementById("timelinearea");
let Timeline = document.getElementById("timeline");
let TimelineObjects = document.getElementById("tl_objects");
let TimelineScale = [0,0];
TimelineArea.addEventListener("wheel",(e)=>{
    if (e.ctrlKey&&!e.shiftKey) { // x軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[0]++;}else {TimelineScale[0]--;}
        if (TimelineScale[0]>20) {TimelineScale[0]=20}
        else if (TimelineScale[0]<-20) {TimelineScale[0]=-20}
        console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.8**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.9**TimelineScale[1]);
    }
    else if (e.ctrlKey&&e.shiftKey) { // y軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[1]++;}else {TimelineScale[1]--;}
        if (TimelineScale[1]>10) {TimelineScale[1]=10}
        else if (TimelineScale[1]<-10) {TimelineScale[1]=-10}
        console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.8**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.9**TimelineScale[1]);
    }
    else {
    }
})

</script>
<script>
document.querySelectorAll(".resizer_Vcontainer").forEach((x)=>{resizer_Vcontainer_addEL(x,0,10,resize);})
document.querySelectorAll(".resizer_Hcontainer").forEach((x)=>{resizer_Hcontainer_addEL(x,0,10,resize);})
</script>
<script> /* keyboard */
document.onkeydown = (e)=>{
    let subarea = document.getElementById("subarea");
    console.log(e.ctrlKey,e.shiftKey,e.keyCode)
    if (e.ctrlKey&&(!e.shiftKey)&&e.keyCode==66) {
        if (subarea.dataset.open=="open") {
            subarea.dataset.open = "close";
        }
        else {
            subarea.dataset.open = "open";
        }
    }
    if (e.ctrlKey&&e.shiftKey&&e.keyCode==66&&subarea.dataset.open=="open") {
        if (subarea.dataset.loc=="right") {
            subarea.dataset.loc = "left";
        }
        else {
            subarea.dataset.loc = "right";
        }
    }
    if (exporting) {e.preventDefault();return false;}
    if (e.keyCode==32&&!editor.isFocused()) {
        togglePlayPreview();
    }
    if (!e.shiftKey&&e.keyCode==39) {
        currentFrame++;
        updatePlayCtrl();
    }
    if (!e.shiftKey&&e.keyCode==37) {
        currentFrame--;
        updatePlayCtrl();
    }
}
</script>
<script>

var currentFrame = 0;
let seekbar = document.querySelector("#seekbar");
let currentFrameShow = document.querySelector("#currentFrame");
let TimeLineTimeBar = document.querySelector("#tl_timebar");
let playbutton = document.querySelector("#playbutton");
let VideoFPS = 30;
seekbar.addEventListener("input",(e)=>{
    if (exporting) {e.preventDefault();return false;}
    currentFrame = Number(seekbar.value);
    updatePlayCtrl();
})
seekbar.addEventListener("change",(e)=>{
    if (exporting) {e.preventDefault();return false;}
    currentFrame = Number(seekbar.value);
    updatePlayCtrl();
})
TimeLineTimeBar.addEventListener("mousedown",(e)=>{
    if (exporting) {e.preventDefault();return false;}
    let resize = (e)=>{
        let ex = e.x - TimelineArea.getBoundingClientRect().left+ TimelineArea.scrollLeft;
        let x = ex/(0.8**TimelineScale[0]);
        if (x<0) {x=0};
        if (x>=Number(seekbar.max)) {x=Number(seekbar.max)};
        currentFrame = x; 
        updatePlayCtrl();
    }
    document.addEventListener("mousemove",resize,false);
    document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
});

function Previewzero() {
    currentFrame = 0;
    updatePlayCtrl();
}
function updatePlayCtrl(f=currentFrame) {
    if (f<0) {f=0};
    if (f>=Number(seekbar.max)) {f=Number(seekbar.max)};
    f = Number(f);
    TimeLineTimeBar.style = `left:calc( ${f}px *var(--tl-x-scale) + 5px);`;
    seekbar.value = f;
    currentFrameShow.innerText = f;
}

var playInterval = false;
playbutton.addEventListener("click",()=>{
    if (exporting) {e.preventDefault();return false;}
    TimelineArea.focus();
    togglePlayPreview();
})
function togglePlayPreview() {
    if (playInterval==false) {
        playInterval = true;
    }
    else {
        playInterval = false;
    }
}

document.getElementById("composevideo").addEventListener("click",()=>{
    window.electron.composeVideo()
})
document.getElementById("export").addEventListener("click",async ()=>{
    if (exporting) {e.preventDefault();return false;}
    exporting = true;
    editor.setReadOnly(true);
    export_frame(0);
})
async function export_frame(i=0) {
    await drawFrame(i);
    updatePlayCtrl(i);
    imgout.toBlob((blob)=>{
        let reader = new FileReader();
        reader.readAsArrayBuffer(blob);
        reader.onload = ()=> {
            var buffer = reader.result;
            console.log("export",i);
            window.electron.exportFrame(i,new Uint8Array(buffer));
        }
    });
    if (i<lastObjFrame-1) {
        setTimeout(export_frame,3,i+1);
    }
    else {
        editor.setReadOnly(false);
        exporting = false;
    }
}
async function makeCache() {
    if (exporting) {setTimeout(makeCache,2000);return false;}
    let flag = false;
    i = currentFrame+10 ;
    while (i<lastObjFrame) {
        if (TLcache[i]==null) {
            flag = true;
            await cacheFrame(i);
            break; 
        }
        i++;
    }
    if (!flag) {
        i = 0;
        while (i<lastObjFrame) {
            if (TLcache[i]==null) {
                flag = true;
                await cacheFrame(i);
                break; 
            }
            i++;
        }
    }
    if (flag) {
        setTimeout(makeCache,0)
    }
}
async function playPreview() {
    if (exporting) {setTimeout(playPreview,2000);return false;}
    const startTime = performance.now();
    updatePlayCtrl();
    let m = await drawFrame(currentFrame);
    const endTime = performance.now();
    if (playInterval) {
        let passedFrame = Math.floor((endTime-startTime)/(1000/VideoFPS)+0.1)
        setTimeout(playPreview,(1000/VideoFPS)-((endTime-startTime)%(1000/VideoFPS)));
        currentFrame+=passedFrame
    }
    else {
        setTimeout(playPreview,100);
    }
    if (playInterval) {
        currentFrame++;
    }
}
setTimeout(makeCache,0)
setTimeout(playPreview,100)

</script>
<script> // TimeLine Objects

function linerinterpolation(p,v1,v2) {
    return (1-p)*v1+p*v2
}

var obj_text = {
    length: (l,t,x,y,s,fin,fout)=>{return l},
    text: (l,t,x,y,s,fin,fout)=>{return "text: "+t},
    textcolor: (l,t,x,y,s,fin,fout)=>{return "#000"},
    color: (l,t,x,y,s,fin,fout)=>{return "#ff5575"},
    getframe: async (af,rf,len,l,t,x,y,s,fin,fout)=>{
        let co = document.createElement("canvas");
        co.height = 1080;
        co.width = 1920;
        let ctx = co.getContext("2d");
        if (rf<fin) {
            ctx.globalAlpha = linerinterpolation(rf/fin,0,1)
        }
        if (rf>=len-fout) {
            ctx.globalAlpha = linerinterpolation((len-rf-1)/(fout),0,1)
        }
        ctx.font = `${s}px serif`;
        ctx.fillStyle = "white";
        ctx.fillText(t,x,y);
        return await canvas2image(co);
    },
}
var obj_rect = {
    length: (l,x,y,w,h,c)=>{return l},
    text: (l,x,y,w,h,c)=>{return "rect"},
    textcolor: (l,x,y,w,h,c)=>{return "#000"},
    color: (l,x,y,w,h,c)=>{return "#88ff55"},
    getframe: async (af,rf,len,x,y,w,h,c)=>{
        let co = document.createElement("canvas");
        co.height = 1080;
        co.width = 1920;
        let ctx = co.getContext("2d");
        ctx.fillStyle = c;
        ctx.strokeStyle = c;
        ctx.rect(x,y,w,h);
        ctx.fill();
        ctx.stroke();
        return await canvas2image(co);
    },
}
var obj_time = {
    length: (l,x,y,s)=>{return l},
    text: (l,x,y,s)=>{return "time"},
    textcolor: (l,x,y,s)=>{return "#000"},
    color: (l,x,y,s)=>{return "#c0c505"},
    getframe: async (af,rf,len,l,x,y,s)=>{
        let co = document.createElement("canvas");
        co.height = 1080;
        co.width = 1920;
        let ctx = co.getContext("2d");
        ctx.font = `${s}px serif`;
        let padding = (num,len)=>{
            return (Array(len).join("0")+num).slice(-len);
        }
        let second = Math.floor(af/VideoFPS*100)/100;
        ctx.fillStyle = "white";
        ctx.fillText(second,x,y);
        return await canvas2image(co);
    },
}

async function canvas2image(canvas){
    const image = new Image();
    return new Promise(
        (resolve) => {
            image.onload = () => {
                resolve(image);
            }
            image.src = canvas.toDataURL();
        }
    )
}

var timeline = [
    [obj_rect,100,100,30,800,300,"#ff5"],
    [obj_text,0,120,"HELLO!!",50,900,200,50,50],
    [obj_rect,120,100,90,500,700,"#f06"],
    [obj_time,80,130,30,500,100,"#f06"],
    [obj_text,10,400,"Neknaj Video Generator",300,600,100,50,50],
    [obj_text,30,300,"bem130",1400,600,70,50,50],
]
let timeLineTmp;
let lastObjFrame;
let TimelineA;
let TLTs = 20;
let TLcache = [];
let drawFrame = async (f)=>{
    if (f<0) {return 0}
    if (f>=lastObjFrame) {return 0}
    if (TLcache[f]==null) {
        let objects = [];
        for (let layer=0;layer<TLTs;layer++) { // 現在のフレームにあるオブジェクトを探す
            if (timeLineTmp[lastObjFrame*layer+f]!=0) {
                objects.push(TimelineA[timeLineTmp[lastObjFrame*layer+f]-1])
            }
        }
        //console.table(objects)
        { // 描画する
            let bufco = document.createElement("canvas");
            bufco.height = 1080;
            bufco.width = 1920;
            bufco.style = imgout.style;
            bufco.id = imgout.id;

            let ctx = bufco.getContext("2d");
            ctx.fillStyle = "black";
            ctx.rect(0,0,1920,1080);
            ctx.fill();
            for (let obj of objects) {
                let objf = await obj.func.getframe(f,f-obj.start,obj.len,...obj.args);
                ctx.drawImage(objf,0,0);
            }
            let imgdata = ctx.getImageData(0,0,1920,1080);
            //console.log("calc") 
            imgout.getContext("2d").putImageData(imgdata,0,0);
        // co.toBlob((blob)=>{console.link(URL.createObjectURL(blob))});
        }
        return 1;
    }
    else {
        //console.log("cache")
        imgout.getContext("2d").putImageData(TLcache[f],0,0);
        return 2;
    }
}
let cacheFrame = async (f)=>{
    if (TLcache[f]==null) {
        let objects = [];
        for (let layer=0;layer<TLTs;layer++) { // 現在のフレームにあるオブジェクトを探す
            if (timeLineTmp[lastObjFrame*layer+f]!=0) {
                objects.push(TimelineA[timeLineTmp[lastObjFrame*layer+f]-1])
            }
        }
        //console.table(objects)
        { // 描画する
            let cachebufco = document.createElement("canvas");
            cachebufco.height = 1080;
            cachebufco.width = 1920;
            cachebufco.style = imgout.style;
            cachebufco.id = imgout.id;

            let ctx = cachebufco.getContext("2d");
            ctx.fillStyle = "black";
            ctx.rect(0,0,1920,1080);
            ctx.fill();
            for (let obj of objects) {
                let objf = await obj.func.getframe(f,f-obj.start,obj.len,...obj.args);
                ctx.drawImage(objf,0,0);
            }
            let imgdata = ctx.getImageData(0,0,1920,1080);
            TLcache[f] = imgdata;
        // co.toBlob((blob)=>{console.link(URL.createObjectURL(blob))});
        }
        return 1;
    }
    else {
        return 2;
    }
}
var TLstat;
var makeTLObject = ()=>{
    TimelineObjects.innerHTML = "";
    lastObjFrame = 0;
    TimelineA = [];
    for (let obj of timeline) { // 各オブジェクトの長さを取得
        console.log(obj)
        let objlen = obj[0].length(...obj.slice(2));
        if (obj[1]+objlen>lastObjFrame) {
            lastObjFrame = obj[1]+objlen;
        }
        TimelineA.push({func:obj[0],start:obj[1],end:obj[1]+objlen,len:objlen,args:obj.slice(2)})
    }
    if (lastObjFrame!=TLcache.length) {
        TLcache = new Array(lastObjFrame).fill(null);
    }
    console.log(lastObjFrame);
    console.table(TimelineA);
    Timeline.style = `width: calc( ${lastObjFrame+10}px *var(--tl-x-scale))`;
    seekbar.max = lastObjFrame;
    timeLineTmp = new Uint8Array(lastObjFrame*TLTs).fill(0);
    let searchLayer = (obj)=>{ // オブジェクトを置くべきレイヤーを探す
        let layer = 0;
        while (layer<TLTs) {
            let flag = true;
            for (let x=0;x<obj.len;x++) {
                if (timeLineTmp[lastObjFrame*layer+obj.start+x]!=0) {
                    flag = false;
                    break;
                }
            }
            if (flag) {
                return layer;
            }
            layer++;
        }
        return false;
    }
    let setObj = (obj,layer,id)=>{ // timeLineTmpとオブジェクトを更新
        for (let x=0;x<obj.len;x++) {
            timeLineTmp[lastObjFrame*layer+obj.start+x]=id+1;
        }
        obj.layer = layer;
        obj.id = id;
    }
    for (let id in TimelineA) { // オブジェクトのレイヤーを決定
        id = Number(id);
        let obj = TimelineA[id];
        let layer = searchLayer(obj);
        setObj(obj,layer,id);
        console.log(layer,id)
    }
    console.table(TimelineA)
    for (let obj of TimelineA) { // 実際のタイムラインに表示する
        let divelm = document.createElement("div");
        divelm.classList.add("object");
        divelm.style = `left:calc( ${obj.start}px *var(--tl-x-scale));top:calc(${obj.layer} *(30px*var(--tl-y-scale) + 5px));width: calc( ${obj.len}px *var(--tl-x-scale) - 4px);background-color: ${obj.func.color(...obj.args)};color: ${obj.func.textcolor(...obj.args)}`;
        divelm.innerText = obj.func.text(...obj.args);
        TimelineObjects.appendChild(divelm);
        obj.tlelm = divelm;
    }
   // <div class="object" style=""></div>
}

makeTLObject()

</script>