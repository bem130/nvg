<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Neknaj Video Generator</title>
        <link rel="stylesheet" href="index.css" />
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
        <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp" />
        <script src="logarea.js"></script>
        <script src="index.js"></script>
        <script src="../node_modules/ace-builds/src/ace.js"></script>
        <script src="../node_modules/ace-builds/src/mode-javascript.js" type="text/javascript" charset="utf-8"></script>
        <script src="../node_modules/neknaj-jsonviewer/jsonviewer.js"></script>
        <link rel="stylesheet" href="../node_modules/neknaj-jsonviewer/jsonviewer.css" />
        <link rel="stylesheet" href="logarea.css" />
    </head>
    <body>
        <div id="topbar">
            <div>
                <img src="./nvg.png">
            </div>
            <div>
                <button type="button" id="openfile">Open File</button>
                <button type="button" id="savefileas">Save As</button>
                <button type="button" id="sidearea">Side Area</button>
                <div>
                    <input type="checkbox" switch id="autosave"><label for="autosave">Auto Save</label>
                </div>
            </div>
            <div>
                <span id="title">　</span>
            </div>
        </div>
        <div id="mainarea" class="resizer_Vcontainer" style="height: calc(100% - 26px);">
            <div class="resizer_content" style="flex-basis: 100%;">
                <div class="resizer_Vcontainer" style="height: 100%;">
                    <div class="resizer_content" style="flex-basis: 80%;">
                        <div class="resizer_Hcontainer" style="height: 100%;">
                            <div class="resizer_content" style="flex-basis: 70%;" id="imgOutArea">
                                <div class="imgOutWindow">
                                    <div id="timebar_padding" class="imgOutArea">
                                        <div id="imgOutPadding"></div>
                                        <canvas id="imgOut" style="transform: scale(0,0);"></canvas>
                                    </div>
                                    <div id="timebar">
                                        <input id="playbutton" type="radio"><label for="playbutton" id="playbuttonlabel">&#x23ef;</label>
                                        <span id="currentFrame">0</span>
                                        <span id="procTime">0</span>
                                        <span id="FrameCache">■</span>
                                        <input type="range" id="seekbar" value="0" min="0" max="1000">
                                    </div>
                                </div>
                            </div>
                            <div class="resizer_splitter"></div>
                            <div class="resizer_content" style="flex-basis: 30%;">
                                <div id="editor" style="height: 100%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="resizer_splitter"></div>
                    <div class="resizer_content" style="flex-basis: 20%;">
                        <div id="timelinearea">
                            <div id="timeline" style="width: calc( 1000px *var(--tl-x-scale))">
                                <div id="tl_timebar" style="left:calc( 10px *var(--tl-x-scale));"></div>
                                <div id="tl_objects">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="resizer_splitter"></div>
            <div class="resizer_content" style="flex-basis: 0%;"><div id="logarea"></div></div>
        </div>
        <div id="subarea" data-open="close" data-loc="left">
            <div class="resizer_Vcontainer" style="height: 100%;">
                <div class="resizer_content" style="flex-basis: 40%;">
                    <div id="partialexport">
                        <h2>Export</h2>
                        <button id="export">Export</button>
                        <button id="cancelexport">Cancel Export</button>
                        <h3>Partial export</h3>
                        <table>
                            <tr>
                                <td><label for="export_range_start">start:</label></td>
                                <td><input type="number" id="export_range_start" min="0" value="0" onchange="checkExportrange()"></td>
                                <td><button onclick="export_range_start.value=0">first frame</button></td>
                                <td><button onclick="export_range_start.value=currentFrame">current playback position</button></td>
                                <td><button onclick="export_range_start.value=lastObjFrame">last frame</button></td>
                            </tr>
                            <tr>
                                <td><label for="export_range_end">end:</label></td>
                                <td><input type="number" id="export_range_end" min="0" value="0" onchange="checkExportrange()"></td>
                                <td><button onclick="export_range_end.value=0">first frame</button></td>
                                <td><button onclick="export_range_end.value=currentFrame">current playback position</button></td>
                                <td><button onclick="export_range_end.value=lastObjFrame">last frame</button></td>
                            </tr>
                        </table>
                        <h3>When export is complete</h3>
                        <div>
                            <input type="checkbox" switch id="autoopenself"><label for="autosave">Open in NVG</label>
                        </div>
                        <div>
                            <input type="checkbox" switch id="autoopendefault"><label for="autosave">Open in default app</label>
                        </div>
                    </div>
                </div>
                <div class="resizer_splitter"></div>
                <div class="resizer_content" style="flex-basis: 60%;">
                    <div>
                        <h2>Export Explorer</h2>
                        <button onclick="window.electron.openPathDefault('./');">Open in explorer</button>
                        <button onclick="window.electron.getFolder('.')">🔄</button>
                        <table id="exportexplorer"></table>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
<script>
function resizer_Vcontainer_addEL (container,framesMin,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let y = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.y-containerRect.y,framesMin,containerRect.height-resizerW-framesMin);
            container.querySelectorAll(":scope > .resizer_content")[0].style.flexBasis = `${y}%`;
            container.querySelectorAll(":scope > .resizer_content")[1].style.flexBasis = `${containerRect.height-resizerW-y}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
function resizer_Hcontainer_addEL (container,framesMin,resizerW,callback=()=>{}) {
    container.querySelector(":scope > .resizer_splitter").addEventListener("mousedown",(e)=>{
        let resize = (e)=>{
            let containerRect = container.getBoundingClientRect();
            let x = ((n,min,max)=>{if (n<min) {n=min}else if (n>max) {n=max};return n;})(e.x-containerRect.x,framesMin,containerRect.width-resizerW-framesMin);
            container.querySelectorAll(":scope > .resizer_content")[0].style.flexBasis = `${x}%`;
            container.querySelectorAll(":scope > .resizer_content")[1].style.flexBasis = `${containerRect.width-resizerW-x}%`;
            callback();
        }
        document.addEventListener("mousemove",resize,false);
        document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
    });
}
</script>
<script>

var editor;
var ProjectInfo = {
    path: null,
    name: null,
}

function SetWindowTitle() {
    document.title = [
        "Neknaj Video Generator",
        data2string(ProjectInfo.name?.name),
        data2string(ProjectInfo.path),
    ].join(" ")
    document.getElementById("title").innerText = [
        data2string(ProjectInfo.name?.name),
        data2string(ProjectInfo.path),
    ].join("　");
}

function updateEditorData(data) {
    editor.setValue(data);
    SetWindowTitle();
    let sel = editor.getSelection();
    let range = sel.getRange();
    range.setStart(0,0);
    range.setEnd(0,0);
    sel.setSelectionRange(range);
}

function data2string(data) {
    if (typeof data=="string") {
        return "\""+data+"\"";
    }
    else {
        return data;
    }
}


function sleep(time) {new Promise(resolve=>setTimeout(resolve,time))}

document.getElementById("openfile").onclick = (e)=>{
    if (exporting) {e.preventDefault();return false;}
    window.electron.openFile();
}
document.getElementById("savefileas").onclick = (e)=>{
    if (exporting) {e.preventDefault();return false;}
    window.electron.saveAs(editor.getValue());
}
let autosave = document.getElementById("autosave");



let videoConfig = {
    "height": 1080,
    "width": 1920,
}
var exporting = false;
var stopExporting = false;

var imgout = document.getElementById("imgOut");

let imgOutArea = document.getElementById("imgOutArea");
// resize window
var canvasScale = 0;
function resize() {
    {
        console.log("resize")
        let scale = 1.05**canvasScale;
        const dw = videoConfig.width;
        const dh = videoConfig.height;
        parent = imgOutArea.getBoundingClientRect();
        let ww = parent.width;
        let wh = parent.height;
        {
            let ws = (ww-25)/dw;
            let hs = (wh-25)/dh;
            console.log(ws,hs)
            scale *= Math.min(ws,hs);
        }
        imgOutPadding.style.width = `${dw*scale+20}px`;
        imgOutPadding.style.height = `${dh*scale+20}px`;
        if (dw*scale+20<=ww&&dh*scale+20<=wh) {
            console.log("a")
            imgout.style.transform = "translate(-50%,-50%) scale("+scale.toString()+","+scale.toString()+")";
            imgout.style.transformOrigin = "center center";
            imgout.style.left = "50%";
            imgout.style.top = "50%";
        }
        else {
            console.log("b")
            imgout.style.transform = "scale("+scale.toString()+","+scale.toString()+")";
            imgout.style.transformOrigin = "top left";
            imgout.style.left = "10px";
            imgout.style.top = "10px";
        }
    }
};
window.onresize = resize;
window.onload = ()=>{
    imgout.height = videoConfig.height;
    imgout.width = videoConfig.width;
    resize();
    SetWindowTitle();
    initEditor();
    Previewzero();
    window.electron.onload();
};
function initEditor() {
    editor = ace.edit("editor");
    editor.setTheme("ace/theme/cobalt");
   // editor.getSession().setMode("ace/mode/javascript");
    editor.getSession().setMode(new (ace.require("ace/mode/javascript").Mode)())
    editor.container.addEventListener("keydown",(e)=>{
        if (exporting) {e.preventDefault();return false;}
        if (e.ctrlKey&&e.key=="o") {
            let cursor = editor.selection.getCursor()
            if (ProjectInfo.path!=null) {
                location.href = ["vscode://file/",ProjectInfo.path,":"+(cursor.row+1)+":"+(cursor.column+1)].join("");
            }
        }
    })
    editor.getSession().on('change', function(){
        if (autosave.checked&&ProjectInfo.path!=null) {
            window.electron.saveFile(ProjectInfo.path,editor.getValue());
        }
    });
}
</script>
<script> /* Timeline */
let TimelineArea = document.getElementById("timelinearea");
let Timeline = document.getElementById("timeline");
let TimelineObjects = document.getElementById("tl_objects");
let TimelineScale = [0,0];
TimelineArea.addEventListener("wheel",(e)=>{
    if (e.ctrlKey&&!e.shiftKey) { // x軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[0]++;}else {TimelineScale[0]--;}
        if (TimelineScale[0]>20) {TimelineScale[0]=20}
        else if (TimelineScale[0]<-20) {TimelineScale[0]=-20}
       // console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.7**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.8**TimelineScale[1]);
    }
    else if (e.ctrlKey&&e.shiftKey) { // y軸の拡大縮小
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {TimelineScale[1]++;}else {TimelineScale[1]--;}
        if (TimelineScale[1]>20) {TimelineScale[1]=20}
        else if (TimelineScale[1]<-10) {TimelineScale[1]=-10}
      //  console.log(TimelineScale);
        Timeline.style.setProperty('--tl-x-scale',0.7**TimelineScale[0]);
        Timeline.style.setProperty('--tl-y-scale',0.8**TimelineScale[1]);
    }
    else {
    }
})
imgOutArea.addEventListener("wheel",(e)=>{
    if (e.ctrlKey) {
        e.preventDefault();
        let wheelval = e.deltaY;
        if (e.deltaY>0) {canvasScale--;}else {canvasScale++;}
        if (canvasScale>50) {canvasScale=50}
        else if (canvasScale<-50) {canvasScale=-50}
        resize();
    }
})

</script>
<script>
document.querySelectorAll(".resizer_Vcontainer").forEach((x)=>{resizer_Vcontainer_addEL(x,0,10,resize);})
document.querySelectorAll(".resizer_Hcontainer").forEach((x)=>{resizer_Hcontainer_addEL(x,0,10,resize);})
</script>
<script> /* keyboard */
document.onkeydown = (e)=>{
    let subarea = document.getElementById("subarea");
    console.log(e.ctrlKey,e.shiftKey,e.keyCode)
    if (e.ctrlKey&&(!e.shiftKey)&&e.keyCode==66) {
        if (subarea.dataset.open=="open") {
            subarea.dataset.open = "close";
        }
        else {
            subarea.dataset.open = "open";
        }
    }
    if (e.ctrlKey&&e.shiftKey&&e.keyCode==66&&subarea.dataset.open=="open") {
        if (subarea.dataset.loc=="right") {
            subarea.dataset.loc = "left";
        }
        else {
            subarea.dataset.loc = "right";
        }
    }
    if (exporting) {e.preventDefault();return false;}
    if (e.keyCode==32&&!editor.isFocused()) {
        togglePlayPreview();
    }
    if (!e.shiftKey&&e.keyCode==39) {
        currentFrame++;
        updatePlayCtrl();
    }
    if (!e.shiftKey&&e.keyCode==37) {
        currentFrame--;
        updatePlayCtrl();
    }
}
</script>
<script>

var currentFrame = 0;
let seekbar = document.querySelector("#seekbar");
let currentFrameShow = document.querySelector("#currentFrame");
let TimeLineTimeBar = document.querySelector("#tl_timebar");
let playbutton = document.querySelector("#playbutton");
let VideoFPS = 30;
seekbar.addEventListener("input",(e)=>{
    if (exporting) {e.preventDefault();return false;}
    currentFrame = Number(seekbar.value);
    updatePlayCtrl();
})
seekbar.addEventListener("change",(e)=>{
    if (exporting) {e.preventDefault();return false;}
    currentFrame = Number(seekbar.value);
    updatePlayCtrl();
})
TimeLineTimeBar.addEventListener("mousedown",(e)=>{
    if (exporting) {e.preventDefault();return false;}
    let resize = (e)=>{
        let ex = e.x - TimelineArea.getBoundingClientRect().left+ TimelineArea.scrollLeft;
        let x = ex/(0.8**TimelineScale[0]);
        if (x<0) {x=0};
        if (x>=Number(seekbar.max)) {x=Number(seekbar.max)};
        currentFrame = Math.round(x);
        updatePlayCtrl();
    }
    document.addEventListener("mousemove",resize,false);
    document.addEventListener("mouseup",()=>{document.removeEventListener("mousemove",resize,false);},false);
});

function Previewzero() {
    currentFrame = 0;
    updatePlayCtrl();
}
function updatePlayCtrl(f=currentFrame) {
    if (f<0) {f=0};
    if (f>=Number(seekbar.max)) {f=Number(seekbar.max)};
    f = Math.round(Number(f));
    TimeLineTimeBar.style = `left:calc( ${f}px *var(--tl-x-scale) + 5px);`;
    seekbar.value = f;
    currentFrameShow.innerText = f;
}

var playInterval = false;
playbutton.addEventListener("click",()=>{
    if (exporting) {e.preventDefault();return false;}
    TimelineArea.focus();
    togglePlayPreview();
})
function togglePlayPreview() {
    if (currentFrame>=Number(seekbar.max)) {currentFrame=0;}
    if (playInterval==false) {
        playInterval = true;
    }
    else {
        playInterval = false;
    }
}

document.getElementById("export").addEventListener("click",async (e)=>{
    if (exporting) {e.preventDefault();return false;}
    if (ProjectInfo.path==null) {console.warn("project file not selected");return false;}
    ExportFrame();
    stopExporting = false;
})
document.getElementById("cancelexport").addEventListener("click",async (e)=>{
    if (!exporting) {console.warn("not exporting")};
    stopExporting = true;
})
document.getElementById("sidearea").addEventListener("click",async (e)=>{
    if (subarea.dataset.open=="open") {
        subarea.dataset.open = "close";
    }
    else {
        subarea.dataset.open = "open";
    }
})
var export_range_start = document.querySelector('#export_range_start');
var export_range_end = document.querySelector('#export_range_end');
function ExportFrame() {
    exporting = true;
    editor.setReadOnly(true);
    playInterval = false;
    checkExportrange();
    let start = Math.floor(Number(export_range_start.value));
    let end = Math.floor(Number(export_range_end.value));
    window.electron.cleanExportFrame(start,end);
    procTime.innerText = "-";
    FrameCache.className = "s4";
    export_frame(start,start,end);
}
function checkExportrange() {
    let start = Math.floor(Number(export_range_start.value));
    let end = Math.floor(Number(export_range_end.value));
    if (start<0) {start=0}
    if (end>lastObjFrame) {end=lastObjFrame}
    if (end<start) {end=start}
    export_range_start.value = Math.round(start);
    export_range_end.value = Math.round(end);
}
async function export_frame(i=0,s,e) {
    exporting = true;
    let drawInfo = await drawFrame(i);
    updatePlayCtrl(i);
    imgout.toBlob((blob)=>{
        let reader = new FileReader();
        reader.readAsArrayBuffer(blob);
        reader.onload = ()=> {
            //console.log("export",i);
            window.electron.exportFrame(i,new Uint8Array(reader.result));
        }
    });
    if (i<e&&!stopExporting) {
        setTimeout(export_frame,0,i+1,s,e);
    }
    else {
        editor.setReadOnly(false);
        exporting = false;
        let fname = "";
        if (s!=0||i!=lastObjFrame) {
            fname = `_${s}-${i}`;
        }
        console.log(fname);
        window.electron.cleanExportFrame(s,i);
        window.electron.composeVideo(s,i,VideoFPS,fname);
        stopExporting = false;
    }
}

var startTime = performance.now();
async function playPreview() {
    if (exporting) {setTimeout(playPreview,2000);return false;}
    updatePlayCtrl();
    let drawInfo = await drawFrame(currentFrame);
    FrameCache.className = "s"+drawInfo;
    const endTime = performance.now()+5;
    if (playInterval) {
        procTime.innerText = Math.floor(endTime-startTime);
        let nextFrame = Math.max((1000/VideoFPS)-endTime+startTime,0);
        //console.log((endTime-startTime),nextFrame)
        if (currentFrame>=seekbar.max) {currentFrame=seekbar.max;playInterval=false;}
        setTimeout(playPreview,nextFrame);
        startTime = performance.now();
    }
    else {
        setTimeout(playPreview,100);
    }
    if (playInterval) {
        currentFrame++;
    }
}
setTimeout(playPreview,100)

</script>
<script> // TimeLine Objects

function linerinterpolation(p,v1,v2) {
    return (1-p)*v1+p*v2
}

var obj_text = {
    length: (l,t,x,y,s,fin,fout)=>{return l},
    text: (l,t,x,y,s,fin,fout)=>{return "text: "+t},
    textcolor: (l,t,x,y,s,fin,fout)=>{return "#000"},
    color: (l,t,x,y,s,fin,fout)=>{return "#ff5575"},
    getframe: async (af,rf,g,len,l,t,x,y,s,fin,fout)=>{
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        const innerText = document.createTextNode(t)
        text.appendChild(innerText)
        text.setAttribute("x",x);
        text.setAttribute("y",y);
        text.setAttribute("font-size",s);
        text.setAttribute("fill","white");
        if (rf<fin) {
            g.setAttribute("fill-opacity",linerinterpolation(rf/fin,0,1))
        }
        if (rf>=len-fout) {
            g.setAttribute("fill-opacity",linerinterpolation((len-rf-1)/(fout),0,1))
        }
        g.appendChild(text);
        
        // let co = document.createElement("canvas");
        // co.height = 1080;
        // co.width = 1920;
        // let ctx = co.getContext("2d");
        // if (rf<fin) {
        //     ctx.globalAlpha = linerinterpolation(rf/fin,0,1)
        // }
        // if (rf>=len-fout) {
        //     ctx.globalAlpha = linerinterpolation((len-rf-1)/(fout),0,1)
        // }
        // ctx.font = `${s}px serif`;
        // ctx.fillStyle = "white";
        // ctx.fillText(t,x,y);
        return;
    },
}
var obj_rect = {
    length: (l,x,y,w,h,c)=>{return l},
    text: (l,x,y,w,h,c)=>{return "rect"},
    textcolor: (l,x,y,w,h,c)=>{return "#000"},
    color: (l,x,y,w,h,c)=>{return "#88ff55"},
    getframe: async (af,rf,g,len,x,y,w,h,c)=>{
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute("x",x);
        rect.setAttribute("y",y);
        rect.setAttribute("width",w);
        rect.setAttribute("height",h);
        rect.setAttribute("fill",c);
        g.appendChild(rect);
        return;
    },
}
var obj_time = {
    length: (l,x,y,s)=>{return l},
    text: (l,x,y,s)=>{return "time"},
    textcolor: (l,x,y,s)=>{return "#000"},
    color: (l,x,y,s)=>{return "#c0c505"},
    getframe: async (af,rf,g,len,l,x,y,s)=>{
        const text = document.createElementNS('http://www.w3.org/2000/svg','text');
        let padding = (num,len)=>{
            return (Array(len).join("0")+num).slice(-len);
        }
        let second = Math.floor(af/VideoFPS*100)/100;
        const innerText = document.createTextNode(second)
        text.appendChild(innerText)
        text.setAttribute("x",x);
        text.setAttribute("y",y);
        text.setAttribute("font-size",s);
        text.setAttribute("fill","white");
        g.appendChild(text);
    },
}

async function canvas2image(canvas){
    const image = new Image();
    return new Promise(
        (resolve) => {
            image.onload = () => {
                resolve(image);
            }
            image.src = canvas.toDataURL();
        }
    )
}
async function svg2image(svg){
    const image = new Image();
    return new Promise(
        (resolve) => {
            image.onload = () => {
                resolve(image);
            }
            image.src = "data:image/svg+xml;charset=utf-8;base64," + btoa(unescape(encodeURIComponent(new XMLSerializer().serializeToString(svg))));
            //console.log(new XMLSerializer().serializeToString(svg))
        }
    )
}

var timeline = [
    [obj_rect,50,1000,30,800,300,"#ff5"],
    [obj_rect,100,100,30,800,300,"#ff5"],
    [obj_rect,120,100,90,500,700,"#f06"],
    [obj_time,80,1700,30,500,100,"#f06"],
    [obj_text,10,1700,"Neknaj Video Generator",300,600,100,50,50],
    [obj_text,30,1700,"bem130",1400,600,70,50,50],
]
for (let t=0;t<100;t++) {
    timeline.push([obj_text,t*300+10,200,"HELLO!!",50+((t+10)%100*10),100+(t%20*50),50,100,100]);
}

let timeLineTmp;
let lastObjFrame;
let TimelineA;
let TLTs = 20;
let beforeImgdata = null;
let FrameCache = document.querySelector("#FrameCache");
let procTime = document.querySelector("#procTime");
let imgoutctx = imgout.getContext("2d");
let drawFrame = async (f)=>{
    if (f<0) {return 0}
    if (f>=lastObjFrame) {return 0}
    if (beforeImgdata==f) {
        return 0;
    }
    {
        let objects = [];
        for (let layer=0;layer<TLTs;layer++) { // 現在のフレームにあるオブジェクトを探す
            if (timeLineTmp[(lastObjFrame+1)*layer+f]!=0) {
                //console.log(lastObjFrame,layer,f,(lastObjFrame+1)*layer+f)
                objects.push(TimelineA[timeLineTmp[(lastObjFrame+1)*layer+f]-1]);
            }
        }
        //console.table(f,objects)
        // 描画する
        let bufco = document.createElement("canvas");
        bufco.height = 1080;
        bufco.width = 1920;
        bufco.style = imgout.style;
        bufco.id = imgout.id;

        let ctx = bufco.getContext("2d");
        ctx.fillStyle = "black";
        ctx.rect(0,0,1920,1080);
        ctx.fill();
        const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
        svg.setAttribute("viewBox","0 0 1920 1080")
        svg.setAttribute("width",1920);
        svg.setAttribute("height",1080);
        for (let obj of objects) {
            const g = document.createElementNS('http://www.w3.org/2000/svg','g');
            await obj.func.getframe(f,f-obj.start,g,obj.len,...obj.args);
            svg.appendChild(g);
        }
        ctx.drawImage(await svg2image(svg),0,0);
        imgoutctx.putImageData(ctx.getImageData(0,0,1920,1080),0,0)
        beforeImgdata = f;

        return 4;
        // co.toBlob((blob)=>{console.link(URL.createObjectURL(blob))});
    }
}



var TLstat;
var makeTLObject = ()=>{
    TimelineObjects.innerHTML = "";
    TimelineA = [];
    lastObjFrame = 0;
    let partialexportUpdate = false;
    if (export_range_end.value==lastObjFrame) {partialexportUpdate=true;}
    for (let obj of timeline) { // 各オブジェクトの長さを取得
        console.log(obj)
        let objlen = obj[0].length(...obj.slice(2));
        if (obj[1]+objlen>lastObjFrame) {
            lastObjFrame = obj[1]+objlen-1;
        }
        TimelineA.push({func:obj[0],start:obj[1],end:obj[1]+objlen-1,len:objlen,args:obj.slice(2)})
    }
    if (partialexportUpdate) {
        export_range_end.value = lastObjFrame;
    }
    export_range_start.max = lastObjFrame;
    export_range_end.max = lastObjFrame;
    //console.log(lastObjFrame);
    //console.table(TimelineA);
    Timeline.style = `width: calc( ${lastObjFrame+10}px *var(--tl-x-scale))`;
    seekbar.max = lastObjFrame;
    timeLineTmp = new Uint32Array((lastObjFrame+1)*TLTs).fill(0);
    let searchLayer = (obj)=>{ // オブジェクトを置くべきレイヤーを探す
        let layer = 0;
        while (layer<TLTs) {
            let flag = true;
            for (let x=0;x<obj.len;x++) {
                if (timeLineTmp[(lastObjFrame+1)*layer+obj.start+x]!=0) {
                    flag = false;
                    break;
                }
            }
            if (flag) {
                return layer;
            }
            layer++;
        }
        return false;
    }
    let setObj = (obj,layer,id)=>{ // timeLineTmpとオブジェクトを更新
        for (let x=0;x<obj.len;x++) {
            timeLineTmp[(lastObjFrame+1)*layer+obj.start+x]=id+1;
        }
        obj.layer = layer;
        obj.id = id;
    }
    for (let id in TimelineA) { // オブジェクトのレイヤーを決定
        id = Number(id);
        let obj = TimelineA[id];
        let layer = searchLayer(obj);
        setObj(obj,layer,id);
        console.log(layer,id)
    }
    console.table(TimelineA)
    for (let obj of TimelineA) { // 実際のタイムラインに表示する
        let divelm = document.createElement("div");
        divelm.classList.add("object");
        divelm.style = `left:calc( ${obj.start}px *var(--tl-x-scale));top:calc(${obj.layer} *(30px*var(--tl-y-scale) + 5px));width: calc( ${obj.len-0.1}px *var(--tl-x-scale) - 4px);background-color: ${obj.func.color(...obj.args)};color: ${obj.func.textcolor(...obj.args)}`;
        divelm.innerText = obj.func.text(...obj.args);
        TimelineObjects.appendChild(divelm);
        obj.tlelm = divelm;
    }
   // <div class="object" style=""></div>
}

makeTLObject()

</script>
<script> // explorer


function ExportsExplorer(result) {
    let exportexplorer = document.querySelector("#exportexplorer");
    exportexplorer.innerHTML = "";
    for (let item of result) {
        if (item[0].ext==".mp4") {
            let trelm = document.createElement("tr");
            exportexplorer.appendChild(trelm);
            {
                let ldelm = document.createElement("td");
                trelm.appendChild(ldelm);
                ldelm.innerText = item[0].base;
            }
            {
                let ldelm = document.createElement("td");
                trelm.appendChild(ldelm);
                let buttonelm = document.createElement("button");
                buttonelm.innerText = "Open in NVG";
                buttonelm.onclick = ()=>{
                    window.electron.openPathSelf("./"+item[0].base);
                }
                trelm.appendChild(buttonelm);
            }
            {
                let ldelm = document.createElement("td");
                trelm.appendChild(ldelm);
                let buttonelm = document.createElement("button");
                buttonelm.innerText = "Open in default app";
                buttonelm.onclick = ()=>{
                    window.electron.openPathDefault("./"+item[0].base);
                }
                trelm.appendChild(buttonelm);
            }
            {
                let ldelm = document.createElement("td");
                trelm.appendChild(ldelm);
                let buttonelm = document.createElement("button");
                buttonelm.innerText = "Open in explorer";
                buttonelm.onclick = ()=>{
                    window.electron.openPathExplorer("./"+item[0].base);
                }
                trelm.appendChild(buttonelm);
            }
        }
    }
}

</script>